<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Year Wrapped</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <style>
        :root {
            --primary: #1db954;
            /* Spotify Green */
            --primary-hover: #1ed760;
            --background-color: #121212;
        }

        body {
            background-color: var(--background-color);
            color: white;
        }

        .hero {
            padding: 4rem 0;
            text-align: center;
            background: linear-gradient(135deg, #1db954 0%, #191414 100%);
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
        }

        .card {
            background-color: #181818;
            border: 1px solid #282828;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: scale(1.02);
            border-color: var(--primary);
        }

        button {
            background-color: var(--primary);
            border-color: var(--primary);
            font-weight: bold;
            border-radius: 2rem;
        }

        button:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
    </style>
</head>

<body>
    <header class="hero">
        <div class="container">
            <h1>ðŸŽ‰ New Year Wrapped</h1>
            <p>Guess the songs, beat your friends!</p>
        </div>
    </header>

    <main class="container">
        <section id="setup">
            <div class="grid">
                <article class="card">
                    <h3>Create a Party</h3>
                    <p>Start a new competition and invite your friends.</p>
                    <form id="create-party-form">
                        <input type="text" id="party-name" placeholder="Party Name" required>
                        <button type="submit">Create Party</button>
                    </form>
                </article>

                <article class="card">
                    <h3>Join a Party</h3>
                    <p>Enter a party ID to join the fun.</p>
                    <form id="join-party-form">
                        <input type="text" id="join-party-id" placeholder="Party ID" required>
                        <button type="submit" class="secondary">Join Party</button>
                    </form>
                </article>
            </div>
        </section>

        <section id="party-room" style="display: none;">
            <h2 id="display-party-name">Party Name</h2>
            <p>Party ID: <code id="display-party-id"></code></p>

            <div id="join-section">
                <h3>Join the Party</h3>
                <form id="submit-songs-form">
                    <input type="text" id="user-name" placeholder="Your Name" required>
                    <fieldset>
                        <legend>Your Top 3 Songs</legend>
                        <input type="text" id="song-1" placeholder="Song 1" required>
                        <input type="text" id="song-2" placeholder="Song 2" required>
                        <input type="text" id="song-3" placeholder="Song 3" required>
                    </fieldset>
                    <button type="submit">Submit & Join</button>
                </form>
            </div>

            <div id="waiting-room" style="display: none;">
                <h3>Waiting for players...</h3>
                <ul id="player-list"></ul>
                <button id="start-btn" style="display: none;">Start Competition</button>
            </div>

            <div id="game-room" style="display: none;">
                <h3 id="round-title">Round 1</h3>
                <div id="songs-to-guess"></div>

                <div id="round-results" style="display: none; margin-top: 2rem;">
                    <h3>Previous Round Results</h3>
                    <ul id="results-list"></ul>
                </div>

                <button id="next-round-btn" style="display: none;">Next Round</button>
                <div id="leaderboard-section" style="display: none;">
                    <h3>Leaderboard</h3>
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        const setupSection = document.getElementById('setup');
        const partyRoom = document.getElementById('party-room');
        const createForm = document.getElementById('create-party-form');
        const joinForm = document.getElementById('join-party-form');
        const submitSongsForm = document.getElementById('submit-songs-form');
        const playerList = document.getElementById('player-list');
        const startBtn = document.getElementById('start-btn');
        const gameRoom = document.getElementById('game-room');
        const songsToGuess = document.getElementById('songs-to-guess');
        const nextRoundBtn = document.getElementById('next-round-btn');
        const leaderboardTable = document.querySelector('#leaderboard-table tbody');

        let currentPartyId = '';
        let isAdmin = false;
        let players = [];

        createForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('party-name').value;
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();

            const res = await fetch('/parties', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, name })
            });

            if (res.ok) {
                showParty(id, name, true);
            }
        };

        joinForm.onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('join-party-id').value.toUpperCase();
            showParty(id, 'Joining...', false);
        };

        function showParty(id, name, admin) {
            currentPartyId = id;
            isAdmin = admin;
            setupSection.style.display = 'none';
            partyRoom.style.display = 'block';
            document.getElementById('display-party-id').innerText = id;
            document.getElementById('display-party-name').innerText = name;
            if (isAdmin) startBtn.style.display = 'block';

            pollStatus();
        }

        submitSongsForm.onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('user-name').value;
            const songs = [
                document.getElementById('song-1').value,
                document.getElementById('song-2').value,
                document.getElementById('song-3').value
            ];

            const res = await fetch(`/parties/${currentPartyId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, songs })
            });

            if (res.ok) {
                document.getElementById('join-section').style.display = 'none';
                document.getElementById('waiting-room').style.display = 'block';
            }
        };

        async function pollStatus() {
            const res = await fetch(`/parties/${currentPartyId}/round`);
            if (res.ok) {
                const status = await res.json();
                if (status.started) {
                    showGame(status);
                    return; // Stop polling for players once started
                }
            }

            const usersRes = await fetch(`/parties/${currentPartyId}/users`);
            if (usersRes.ok) {
                players = await usersRes.json();
                if (players !== null) {
                    playerList.innerHTML = players.map(u => `<li>${u.name}</li>`).join('');
                }
            }
            setTimeout(pollStatus, 3000);
        }

        function showGame(status) {
            document.getElementById('waiting-room').style.display = 'none';
            document.getElementById('join-section').style.display = 'none';
            gameRoom.style.display = 'block';

            if (status.songs.length === 0 && status.current_round > 1) {
                document.getElementById('round-title').innerText = "Game Over!";
                songsToGuess.innerHTML = "<p>All songs have been revealed. Check the final leaderboard!</p>";
                if (isAdmin) nextRoundBtn.style.display = 'none';
                showResults(status.current_round - 1);
                updateLeaderboard();
                return;
            }

            document.getElementById('round-title').innerText = `Round ${status.current_round}`;

            if (isAdmin) nextRoundBtn.style.display = 'block';

            songsToGuess.innerHTML = status.songs.map(song => `
                <article class="card">
                    <header>ðŸŽµ ${song.title}</header>
                    <select onchange="submitGuess(${song.id}, this.value)">
                        <option value="">Who's song is this?</option>
                        ${players.map(p => `<option value="${p.name}">${p.name}</option>`).join('')}
                    </select>
                </article>
            `).join('');

            if (status.current_round > 1) {
                showResults(status.current_round - 1);
            }

            updateLeaderboard();
        }

        async function showResults(round) {
            const res = await fetch(`/parties/${currentPartyId}/results?round=${round}`);
            if (res.ok) {
                const results = await res.json();
                const resultsList = document.getElementById('results-list');
                resultsList.innerHTML = results.map(r => `
                    <li><strong>${r.SongTitle}</strong> was by <strong>${r.OwnerName}</strong></li>
                `).join('');
                document.getElementById('round-results').style.display = 'block';
            }
        }

        async function submitGuess(songId, ownerName) {
            if (!ownerName) return;
            const userName = document.getElementById('user-name').value;
            await fetch(`/parties/${currentPartyId}/guess`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_name: userName, song_id: songId, owner_name: ownerName })
            });
        }

        async function updateLeaderboard() {
            const res = await fetch(`/parties/${currentPartyId}/leaderboard`);
            if (res.ok) {
                const scores = await res.json();
                leaderboardTable.innerHTML = scores.map(s => `
                    <tr><td>${s.userName}</td><td>${s.score}</td></tr>
                `).join('');
                document.getElementById('leaderboard-section').style.display = 'block';
            }
        }

        startBtn.onclick = async () => {
            await fetch(`/parties/${currentPartyId}/start`, { method: 'POST' });
        };

        nextRoundBtn.onclick = async () => {
            await fetch(`/parties/${currentPartyId}/next`, { method: 'POST' });
            pollStatus();
        };
    </script>
</body>

</html>