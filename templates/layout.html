{{define "layout"}}
<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Year Wrapped</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --background-color: #121212;
        }

        body {
            background-color: var(--background-color);
            color: white;
        }

        .hero {
            padding: 2rem 0;
            text-align: center;
            background: linear-gradient(135deg, #1db954 0%, #191414 100%);
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
        }

        .card {
            background-color: #181818;
            border: 1px solid #282828;
        }

        .card header  {
            margin-bottom: 0;
        }

        .card footer {
            margin-top: 0;
        }

        button {
            background-color: var(--primary);
            border-color: var(--primary);
            border-radius: 2rem;
            font-weight: bold;
        }

        button.secondary {
            background-color: transparent;
            border-color: var(--primary);
            color: var(--primary);
        }
    </style>
    <meta name="description" content="New Year Wrapped - A Music-Wrapped competition to guess your friends' top songs.">
    <meta name="author" content="Nikolaj J-K">
    <meta name="keywords" content="New Year Wrapped, Music Competition, YouTube Music, Party Game">
</head>

<body>
    <header class="hero">
        <div class="container">
            <h1>New Year Wrapped üéâ</h1>
            {{if .Party}}<h2>{{.Party.Name}}</h2>{{end}}
        </div>
    </header>

    <main class="container">
        {{if not .Party}}
        {{template "index" .}}
        {{else if .IsSongList}}
        {{template "song_list" .}}
        {{else if .Started}}
        {{template "game" .}}
        {{else}}
        {{template "party" .}}
        {{end}}
    </main>

    <footer class="container"
        style="text-align: center; margin-top: 1rem; padding: 2rem 0; border-top: 1px solid #282828; opacity: 0.7;">
        <small>
            New Year Wrapped 2025 &bull;
            <a href="https://github.com/jehaj/new-year-wrapped" target="_blank" class="secondary">GitHub</a> &bull;
            Built with Go & Pico CSS
        </small>
    </footer>

    <script>
        let searchTimeout;
        async function searchSongs(input, resultsId, songNum, immediate = false) {
            const query = input.value;
            const resultsDiv = document.getElementById(resultsId);
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            const doSearch = async () => {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const songs = await response.json();

                    resultsDiv.innerHTML = '';
                    songs.forEach(song => {
                        const div = document.createElement('div');
                        div.className = 'search-result';
                        div.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <img data-src="${song.thumbnail_url}" class="lazy-thumb">
                                <div class="song-info">
                                    <div class="song-title">${song.title}</div>
                                </div>
                            </div>
                        `;
                        div.onclick = (e) => {
                            e.stopPropagation();
                            input.value = song.title;
                            document.getElementById(`song${songNum}_id`).value = song.youtube_id;
                            document.getElementById(`song${songNum}_thumb`).value = song.thumbnail_url;
                            resultsDiv.innerHTML = '';
                        };
                        resultsDiv.appendChild(div);
                    });

                    loadImagesLazy();
                } catch (err) {
                    console.error('Search failed', err);
                }
            };

            clearTimeout(searchTimeout);
            if (immediate) {
                doSearch();
            } else {
                searchTimeout = setTimeout(doSearch, 400);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.search-results-container').forEach(div => {
                div.innerHTML = '';
            });
        });

        let imageQueue = [];
        let isProcessingQueue = false;

        function loadImagesLazy() {
            const images = document.querySelectorAll('.lazy-thumb[data-src]');
            images.forEach(img => {
                if (!imageQueue.includes(img)) {
                    imageQueue.push(img);
                }
            });
            if (!isProcessingQueue) {
                processImageQueue();
            }
        }

        async function processImageQueue() {
            if (imageQueue.length === 0) {
                isProcessingQueue = false;
                return;
            }
            isProcessingQueue = true;
            const img = imageQueue.shift();
            const src = img.getAttribute('data-src');

            try {
                await loadImageWithRetry(img, src);
            } catch (e) {
                console.error('Failed to load image', src);
            }

            setTimeout(processImageQueue, 250);
        }

        async function loadImageWithRetry(img, src, retryCount = 0) {
            return new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = async () => {
                    if (retryCount < 3) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        setTimeout(() => {
                            loadImageWithRetry(img, src, retryCount + 1).then(resolve).catch(reject);
                        }, delay);
                    } else {
                        reject();
                    }
                };
                img.src = src;
                img.removeAttribute('data-src');
            });
        }
    </script>
</body>

</html>
{{end}}

{{define "index"}}
<section id="setup">
    <div class="grid">
        <article class="card">
            <h3>Create a Party</h3>
            <form action="/ui/parties/create" method="POST">
                <input type="text" name="name" placeholder="Party Name" required>
                <button type="submit">Create Party</button>
            </form>
        </article>

        <article class="card">
            <h3>Join a Party</h3>
            <form action="/parties" method="GET">
                <input type="text" name="id" placeholder="Party ID" required>
                <button type="submit" class="secondary">Join Party</button>
            </form>
        </article>
    </div>
</section>
{{end}}

{{define "party"}}
<section id="party-room">
    <p>Party ID: <code>{{.Party.ID}}</code></p>

    {{if .IsAdmin}}
    <div style="text-align: center; margin-bottom: 2rem;">
        <img src="/parties/{{.Party.ID}}/qrcode" alt="Join QR Code"
            style="max-width: 200px; border: 10px solid white; border-radius: 10px;">
        <p><small>Share this QR code with your friends!</small></p>
    </div>
    {{end}}

    {{if not .UserJoined}}
    <div id="join-section">
        <h3>Join the Party</h3>
        <form action="/ui/parties/{{.Party.ID}}/join" method="POST" onsubmit="return validateSongs()">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <input type="text" name="user_name" placeholder="Your Name" required>
            <fieldset>
                <legend>Your Top 3 Songs</legend>
                <div class="song-input-group">
                    <input type="text" name="song1" id="song1" placeholder="Search Song 1..." required
                        oninput="searchSongs(this, 'results1', 1)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results1', 1, true)" autocomplete="off">
                    <input type="hidden" name="song1_id" id="song1_id">
                    <input type="hidden" name="song1_thumb" id="song1_thumb">
                    <div id="results1" class="search-results-container"></div>
                </div>
                <div class="song-input-group">
                    <input type="text" name="song2" id="song2" placeholder="Search Song 2..." required
                        oninput="searchSongs(this, 'results2', 2)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results2', 2, true)" autocomplete="off">
                    <input type="hidden" name="song2_id" id="song2_id">
                    <input type="hidden" name="song2_thumb" id="song2_thumb">
                    <div id="results2" class="search-results-container"></div>
                </div>
                <div class="song-input-group">
                    <input type="text" name="song3" id="song3" placeholder="Search Song 3..." required
                        oninput="searchSongs(this, 'results3', 3)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results3', 3, true)" autocomplete="off">
                    <input type="hidden" name="song3_id" id="song3_id">
                    <input type="hidden" name="song3_thumb" id="song3_thumb">
                    <div id="results3" class="search-results-container"></div>
                </div>
            </fieldset>
            <button type="submit">Submit & Join</button>
        </form>
    </div>

    <script>
        function validateSongs() {
            if (!document.getElementById('song1_id').value ||
                !document.getElementById('song2_id').value ||
                !document.getElementById('song3_id').value) {
                alert('Please select all 3 songs from the search suggestions.');
                return false;
            }
            return true;
        }
    </script>
    <style>
        .song-input-group {
            position: relative;
            margin-bottom: var(--pico-spacing);
        }

        .song-input-group input {
            margin-bottom: 0;
        }

        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #181818;
            border: 1px solid #282828;
            border-top: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .search-results-container:not(:empty) {
            display: block;
        }

        .search-result {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #282828;
            transition: background 0.2s;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .search-result:hover {
            background: #282828;
        }

        .search-result img {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
            background: #282828;
        }

        .search-result .song-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-result .song-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    {{else}}
    <div id="waiting-room">
        <h3>Waiting for players...</h3>
        <ul>
            {{range .Users}}<li>{{.Name}}</li>{{end}}
        </ul>
        <div class="grid">
            {{if .IsAdmin}}
            <form action="/ui/parties/{{.Party.ID}}/start" method="POST">
                <input type="hidden" name="admin_token" value="{{.AdminToken}}">
                <input type="hidden" name="user_name" value="{{.UserName}}">
                <button type="submit">Start Competition</button>
            </form>
            <div>
                <a href="/parties/{{.Party.ID}}/song_list?admin_token={{.AdminToken}}&user={{.UserName}}" role="button"
                    class="secondary" style="width: 100%;">View Song List</a>
            </div>
            {{else}}
            <p>Waiting for admin to start...</p>
            {{end}}
            <form action="/parties/{{.Party.ID}}" method="GET">
                <input type="hidden" name="user" value="{{.UserName}}">
                <input type="hidden" name="admin_token" value="{{.AdminToken}}">
                <button type="submit" class="secondary">Refresh Players</button>
            </form>
        </div>
    </div>
    {{end}}
</section>
{{end}}

{{define "game"}}
<section id="game-room">
    {{if .GameOver}}
    <article class="card">
        <header>üèÜ Game Over!</header>
        <p>All songs have been guessed and revealed. Check the final leaderboard below!</p>
    </article>
    {{else}}
    <h3>Round {{.CurrentRound}} {{if .ShowResults}}- Results{{else}}- Guessing{{end}}</h3>

    {{if not .ShowResults}}
    <div id="songs-to-guess">
        {{range .Songs}}
        <article class="card">
            <header>üéµ {{.Title}}</header>
            <form action="/ui/parties/{{$.Party.ID}}/guess" method="POST">
                <input type="hidden" name="user_name" value="{{$.UserName}}">
                <input type="hidden" name="admin_token" value="{{$.AdminToken}}">
                <input type="hidden" name="song_id" value="{{.ID}}">
                {{$guessedOwner := index $.UserGuesses .ID}}
                <div class="grid">
                    <select name="owner_name" required {{if $guessedOwner}}disabled{{end}}>
                        <option value="">Who's song is this?</option>
                        {{range $.Users}}
                        <option value="{{.Name}}" {{if eq .Name $guessedOwner}}selected{{end}}>{{.Name}}</option>
                        {{end}}
                    </select>
                    <button type="submit" {{if $guessedOwner}}disabled{{end}}>
                        {{if $guessedOwner}}You have already guessed{{else}}Guess{{end}}
                    </button>
                </div>
            </form>
        </article>
        {{else}}
        <p>No more songs this round!</p>
        {{end}}
    </div>
    {{else}}
    <div id="round-results">
        <article class="card">
            <header>Round {{.CurrentRound}} Reveals</header>
            <ul>
                {{range .PreviousResults}}
                <li><strong>{{.Title}}</strong> was by <strong>{{.OwnerName}}</strong></li>
                {{end}}
            </ul>
        </article>
    </div>
    {{end}}
    {{end}}

    <div id="leaderboard-section" style="margin-top: 2rem;">
        <div class="grid">
            {{if not .GameOver}}
            <div>
                <h3>{{if .ShowResults}}Round {{.CurrentRound}} Results{{else}}Previous Round Results{{end}}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Leaderboard}}
                        <tr>
                            <td>{{.UserName}}</td>
                            <td>{{.Score}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            {{end}}
            <div>
                <h3>{{if .GameOver}}Final Leaderboard{{else}}Global Leaderboard{{end}}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .GlobalLeaderboard}}
                        <tr>
                            <td>{{.UserName}}</td>
                            <td>{{.Score}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid">
        {{if and .IsAdmin (not .GameOver)}}
        <form action="/ui/parties/{{.Party.ID}}/next" method="POST">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <input type="hidden" name="user_name" value="{{.UserName}}">
            <button type="submit">
                {{if .ShowResults}}Next Round{{else}}Reveal Results{{end}}
            </button>
        </form>
        <div>
            <a href="/parties/{{.Party.ID}}/song_list?admin_token={{.AdminToken}}&user={{.UserName}}" role="button"
                class="secondary" style="width: 100%;">View Song List</a>
        </div>
        {{end}}

        <form action="/parties/{{.Party.ID}}/game" method="GET">
            <input type="hidden" name="user" value="{{.UserName}}">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <button type="submit" class="secondary">Refresh Round</button>
        </form>
    </div>
</section>
{{end}}

{{define "song_list"}}
<section id="song-list">
    <header>
        <h3>Party Song List</h3>
        <p>Admin view of all songs in the party.</p>
    </header>

    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        {{range .Songs}}
        <article class="card" style="flex: 1 1 calc(33.333% - 1rem); min-width: 300px; margin-bottom: 0;">
            <header>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img src="{{.ThumbnailURL}}" style="width: 60px; height: 60px; border-radius: 4px;">
                    <div>
                        <strong>{{.Title}}</strong><br>
                        <small>Owner: {{.OwnerName}}</small>
                    </div>
                </div>
            </header>
            <footer>
                <a href="https://music.youtube.com/watch?v={{.YouTubeID}}" target="_blank" role="button"
                    class="secondary">Play on YouTube Music</a>
            </footer>
        </article>
        {{else}}
        <p>No songs have been added yet.</p>
        {{end}}
    </div>

    <div style="margin-top: 2rem;">
        <a href="/parties/{{.Party.ID}}?admin_token={{.AdminToken}}&user={{.UserName}}" role="button">Back to Party</a>
    </div>
</section>
{{end}}