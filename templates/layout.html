{{define "layout"}}
<!DOCTYPE html>
<html lang="da" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyt친rs Wrapped</title>
    <link rel="stylesheet" href="/static/css/pico.min.css">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        :root {
            --primary: #1db954;
            --primary-hover: #1ed760;
            --background-color: #121212;
        }

        body {
            background-color: var(--background-color);
            color: white;
        }

        .hero {
            padding: 2rem 0;
            text-align: center;
            background: linear-gradient(135deg, #1db954 0%, #191414 100%);
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
        }

        .card {
            background-color: #181818;
            border: 1px solid #282828;
        }

        button {
            background-color: var(--primary);
            border-color: var(--primary);
            border-radius: 2rem;
            font-weight: bold;
        }

        button.secondary {
            background-color: transparent;
            border-color: var(--primary);
            color: var(--primary);
        }

        .spoiler {
            display: block;
            width: 100%;
            background-color: #282828;
            color: transparent;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
            user-select: none;
            margin-top: 4px;
        }

        header>div>div {
            width: 100%;
        }

        .spoiler:hover,
        .spoiler:focus,
        .spoiler:active {
            background-color: transparent;
            color: inherit;
            user-select: text;
        }

        .guess-correct {
            color: #1db954;
            font-weight: bold;
        }

        .guess-incorrect {
            color: #e91e1e;
            font-weight: bold;
        }
    </style>
    <meta name="description" content="Nyt친rs Wrapped - G칝t hinandens yndlingssange.">
    <meta name="author" content="Nikolaj J-K">
    <meta name="keywords" content="Nyt친rs Wrapped, Musikkonkurrence, YouTube Music, Selskabsleg">
</head>

<body>
    <header class="hero">
        <div class="container">
            <h1>Nyt친rs Wrapped 游꿀</h1>
            {{if .Party}}<h2>{{.Party.Name}}</h2>{{end}}
        </div>
    </header>

    <main class="container">
        {{if not .Party}}
        {{template "index" .}}
        {{else if .IsSongList}}
        {{template "song_list" .}}
        {{else if .Started}}
        {{template "game" .}}
        {{else}}
        {{template "party" .}}
        {{end}}
    </main>

    <footer class="container"
        style="text-align: center; margin-top: 1rem; padding: 2rem 0; border-top: 1px solid #282828; opacity: 0.7;">
        <small>
            Nyt친rs Wrapped 2025 &bull;
            <a href="https://github.com/jehaj/new-year-wrapped" target="_blank" class="secondary">GitHub</a> &bull;
            Bygget med Go & Pico CSS
        </small>
    </footer>

    <script>
        let searchTimeout;
        async function searchSongs(input, resultsId, songNum, immediate = false) {
            const query = input.value;
            const resultsDiv = document.getElementById(resultsId);
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            const doSearch = async () => {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const songs = await response.json();

                    resultsDiv.innerHTML = '';
                    songs.forEach(song => {
                        const div = document.createElement('div');
                        div.className = 'search-result';
                        div.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <img data-src="${song.thumbnail_url}" class="lazy-thumb">
                                <div class="song-info">
                                    <div class="song-title">${song.title}</div>
                                </div>
                            </div>
                        `;
                        div.onclick = (e) => {
                            e.stopPropagation();
                            input.value = song.title;
                            document.getElementById(`song${songNum}_id`).value = song.youtube_id;
                            document.getElementById(`song${songNum}_thumb`).value = song.thumbnail_url;
                            resultsDiv.innerHTML = '';
                        };
                        resultsDiv.appendChild(div);
                    });

                    loadImagesLazy();
                } catch (err) {
                    console.error('Search failed', err);
                }
            };

            clearTimeout(searchTimeout);
            if (immediate) {
                doSearch();
            } else {
                searchTimeout = setTimeout(doSearch, 250);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.search-results-container').forEach(div => {
                div.innerHTML = '';
            });
        });

        let imageQueue = [];
        let isProcessingQueue = false;

        function loadImagesLazy() {
            const images = document.querySelectorAll('.lazy-thumb[data-src]');
            images.forEach(img => {
                if (!imageQueue.includes(img)) {
                    imageQueue.push(img);
                }
            });
            if (!isProcessingQueue) {
                processImageQueue();
            }
        }

        async function processImageQueue() {
            if (imageQueue.length === 0) {
                isProcessingQueue = false;
                return;
            }
            isProcessingQueue = true;
            const img = imageQueue.shift();

            // Skip if the image is no longer in the document (e.g. search results cleared)
            if (!img.isConnected) {
                processImageQueue();
                return;
            }

            const src = img.getAttribute('data-src');

            try {
                await loadImageWithRetry(img, src);
            } catch (e) {
                console.error('Failed to load image', src);
            }

            setTimeout(processImageQueue, 350);
        }

        async function loadImageWithRetry(img, src, retryCount = 0) {
            return new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = async () => {
                    if (retryCount < 3) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        setTimeout(() => {
                            loadImageWithRetry(img, src, retryCount + 1).then(resolve).catch(reject);
                        }, delay);
                    } else {
                        reject();
                    }
                };
                img.src = src;
                img.removeAttribute('data-src');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const guessingSection = document.getElementById('guessing-section');
            if (guessingSection) {
                guessingSection.addEventListener('submit', async (e) => {
                    if (e.target.tagName === 'FORM' && e.target.action.includes('/guess')) {
                        e.preventDefault();
                        const form = e.target;
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const select = form.querySelector('select[name="owner_name"]');

                        if (submitBtn) submitBtn.disabled = true;
                        if (select) select.disabled = true;

                        const formData = new FormData(form);
                        try {
                            const response = await fetch(form.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });
                            if (response.ok) {
                                if (submitBtn) {
                                    submitBtn.textContent = `Dit g칝t: ${select.value}`;
                                    submitBtn.type = 'button';
                                    submitBtn.classList.add('secondary');
                                }
                            } else {
                                if (submitBtn) submitBtn.disabled = false;
                                if (select) select.disabled = false;
                                alert('Der skete en fejl ved afsendelse af g칝t.');
                            }
                        } catch (error) {
                            console.error('Error submitting guess:', error);
                            if (submitBtn) submitBtn.disabled = false;
                            if (select) select.disabled = false;
                            alert('Der skete en netv칝rksfejl.');
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>
{{end}}

{{define "index"}}
<section id="setup">
    <div class="grid">
        <article class="card">
            <h3>Opret en fest</h3>
            <form action="/ui/parties/create" method="POST">
                <input type="text" name="name" placeholder="Festnavn" required>
                <button type="submit">Opret fest</button>
            </form>
        </article>

        <article class="card">
            <h3>Deltag i en fest</h3>
            <form action="/parties" method="GET">
                <input type="text" name="id" placeholder="Fest-ID" required>
                <button type="submit" class="secondary">Deltag i fest</button>
            </form>
        </article>
    </div>
</section>
{{end}}

{{define "party"}}
<section id="party-room">
    <p>Fest-ID: <code>{{.Party.ID}}</code></p>

    {{if .IsAdmin}}
    <div style="text-align: center; margin-bottom: 2rem;">
        <img src="/parties/{{.Party.ID}}/qrcode" alt="Join QR Code"
            style="max-width: 200px; border: 10px solid white; border-radius: 10px;">
        <p><small>Andre kan deltage med denne QR-kode!</small></p>
    </div>
    {{end}}

    {{if not .UserJoined}}
    <div id="join-section">
        <h3>Deltag i festen</h3>
        <form action="/ui/parties/{{.Party.ID}}/join" method="POST" onsubmit="return validateSongs()">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <input type="text" name="user_name" placeholder="Dit navn" required>
            <fieldset>
                <legend>Dine top 3 sange</legend>
                <div class="song-input-group">
                    <input type="text" name="song1" id="song1" placeholder="S칮g efter sang 1..." required
                        oninput="searchSongs(this, 'results1', 1)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results1', 1, true)" autocomplete="off">
                    <input type="hidden" name="song1_id" id="song1_id">
                    <input type="hidden" name="song1_thumb" id="song1_thumb">
                    <div id="results1" class="search-results-container"></div>
                </div>
                <div class="song-input-group">
                    <input type="text" name="song2" id="song2" placeholder="S칮g efter sang 2..." required
                        oninput="searchSongs(this, 'results2', 2)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results2', 2, true)" autocomplete="off">
                    <input type="hidden" name="song2_id" id="song2_id">
                    <input type="hidden" name="song2_thumb" id="song2_thumb">
                    <div id="results2" class="search-results-container"></div>
                </div>
                <div class="song-input-group">
                    <input type="text" name="song3" id="song3" placeholder="S칮g efter sang 3..." required
                        oninput="searchSongs(this, 'results3', 3)"
                        onclick="event.stopPropagation(); searchSongs(this, 'results3', 3, true)" autocomplete="off">
                    <input type="hidden" name="song3_id" id="song3_id">
                    <input type="hidden" name="song3_thumb" id="song3_thumb">
                    <div id="results3" class="search-results-container"></div>
                </div>
            </fieldset>
            <button type="submit">Indsend & deltag</button>
        </form>
    </div>

    <script>
        function validateSongs() {
            if (!document.getElementById('song1_id').value ||
                !document.getElementById('song2_id').value ||
                !document.getElementById('song3_id').value) {
                alert('V칝lg venligst alle 3 sange fra s칮geforslagene.');
                return false;
            }
            return true;
        }
    </script>
    <style>
        .song-input-group {
            position: relative;
            margin-bottom: var(--pico-spacing);
        }

        .song-input-group input {
            margin-bottom: 0;
        }

        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #181818;
            border: 1px solid #282828;
            border-top: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .search-results-container:not(:empty) {
            display: block;
        }

        .search-result {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #282828;
            transition: background 0.2s;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .search-result:hover {
            background: #282828;
        }

        .search-result img {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            object-fit: cover;
            background: #282828;
        }

        .search-result .song-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-result .song-title {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    {{else}}
    <div id="waiting-room">
        <h3>Venter p친 spillere...</h3>
        <ul>
            {{range .Users}}<li>{{.Name}}</li>{{end}}
        </ul>
        <div class="grid">
            {{if .IsAdmin}}
            <form action="/ui/parties/{{.Party.ID}}/start" method="POST">
                <input type="hidden" name="admin_token" value="{{.AdminToken}}">
                <input type="hidden" name="user_name" value="{{.UserName}}">
                <button type="submit">Start konkurrencen</button>
            </form>
            <div>
                <a href="/parties/{{.Party.ID}}/song_list?admin_token={{.AdminToken}}&user={{.UserName}}" role="button"
                    class="secondary" style="width: 100%;">Se sangliste</a>
            </div>
            {{else}}
            <p>Venter p친 at administratoren starter...</p>
            {{end}}
            <form action="/parties/{{.Party.ID}}" method="GET">
                <input type="hidden" name="user" value="{{.UserName}}">
                <input type="hidden" name="admin_token" value="{{.AdminToken}}">
                <button type="submit" class="secondary">Opdater spillere</button>
            </form>
        </div>
    </div>
    {{end}}
</section>
{{end}}

{{define "game"}}
<section id="game-room">
    {{if .GameOver}}
    <article class="card">
        <header>Spillet er slut!</header>
        <p>Alle sange er blevet g칝ttet og afsl칮ret. Se dine resultater og den endelige rangliste nedenfor!</p>
    </article>

    <article class="card">
        <header>Dine g칝t</header>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Sang</th>
                        <th>Dit g칝t</th>
                        <th>Rigtig ejer</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .PreviousResults}}
                    {{$guess := index $.UserGuesses .ID}}
                    <tr>
                        <td>{{.Title}}</td>
                        <td class="{{if .IsCorrect $guess}}guess-correct{{else if $guess}}guess-incorrect{{end}}">
                            {{if $guess}}{{$guess}}{{else}}<em>Intet g칝t</em>{{end}}
                        </td>
                        <td>{{.OwnerName}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </article>
    {{else}}
    <h3>Runde {{.CurrentRound}} {{if .ShowResults}}- Resultater{{else}}- G칝t{{end}}</h3>

    {{if not .ShowResults}}
    <div id="guessing-section">
        {{range .Songs}}
        {{$guess := index $.UserGuesses .ID}}
        <article class="card">
            <header>
                <strong>{{.Title}}</strong>
            </header>
            <form action="/ui/parties/{{$.Party.ID}}/guess" method="POST" style="margin-bottom: 0;">
                <input type="hidden" name="user_name" value="{{$.UserName}}">
                <input type="hidden" name="admin_token" value="{{$.AdminToken}}">
                <input type="hidden" name="song_id" value="{{.ID}}">
                <div class="grid">
                    <select name="owner_name" required {{if $guess}}disabled{{end}}>
                        <option value="" disabled {{if not $guess}}selected{{end}}>Hvem ejer denne sang?</option>
                        {{range $.Users}}
                        <option value="{{.Name}}" {{if eq .Name $guess}}selected{{end}}>{{.Name}}</option>
                        {{end}}
                    </select>
                    {{if not $guess}}
                    <button type="submit">G칝t</button>
                    {{else}}
                    <button type="button" class="secondary" disabled>Dit g칝t: {{$guess}}</button>
                    {{end}}
                </div>
            </form>
        </article>
        {{end}}
    </div>
    {{else}}
    <div id="round-results">
        <article class="card">
            <header>Afsl칮ringer for runde {{.CurrentRound}}</header>
            <ul>
                {{range .PreviousResults}}
                {{$guess := index $.UserGuesses .ID}}
                <li>
                    <strong>{{.Title}}</strong> var fra <strong>{{.OwnerName}}</strong>
                    {{if $guess}}
                    <br><small>Dit g칝t: <span
                            class="{{if .IsCorrect $guess}}guess-correct{{else}}guess-incorrect{{end}}">{{$guess}}</span></small>
                    {{else}}
                    <br><small><em>Du g칝ttede ikke p친 denne sang.</em></small>
                    {{end}}
                </li>
                {{end}}
            </ul>
        </article>
    </div>
    {{end}}
    {{end}}

    <div id="leaderboard-section" style="margin-top: 2rem;">
        <div class="grid">
            {{if not .GameOver}}
            <div>
                <h3>{{if .ShowResults}}Resultater for runde {{.CurrentRound}}{{else}}Resultater fra forrige runde{{end}}
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th>Spiller</th>
                            <th>Point</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Leaderboard}}
                        <tr>
                            <td>{{.UserName}}</td>
                            <td>{{.Score}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            {{end}}
            <div>
                <h3>{{if .GameOver}}Endelig rangliste{{else}}Samlet rangliste{{end}}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Spiller</th>
                            <th>Point</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .GlobalLeaderboard}}
                        <tr>
                            <td>{{.UserName}}</td>
                            <td>{{.Score}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="grid">
        {{if and .IsAdmin (not .GameOver)}}
        <form action="/ui/parties/{{.Party.ID}}/next" method="POST">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <input type="hidden" name="user_name" value="{{.UserName}}">
            <button type="submit">
                {{if .ShowResults}}N칝ste runde{{else}}Afsl칮r resultater{{end}}
            </button>
        </form>
        <div>
            <a href="/parties/{{.Party.ID}}/song_list?admin_token={{.AdminToken}}&user={{.UserName}}" role="button"
                class="secondary" style="width: 100%;">Se sangliste</a>
        </div>
        {{end}}

        <form action="/parties/{{.Party.ID}}/game" method="GET">
            <input type="hidden" name="user" value="{{.UserName}}">
            <input type="hidden" name="admin_token" value="{{.AdminToken}}">
            <button type="submit" class="secondary">Opdater runde</button>
        </form>
    </div>
</section>
{{end}}

{{define "song_list"}}
<section id="song-list">
    <header>
        <h3>Festens sangliste</h3>
        <p>Administratorvisning af alle sange i festen.</p>
    </header>

    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        {{range .Songs}}
        <article class="card"
            style="flex: 1 1 calc(33.333% - 1rem); min-width: 300px; margin-bottom: 0; display: flex; flex-direction: column;">
            <header style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img src="{{.ThumbnailURL}}" style="width: 60px; height: 60px; border-radius: 4px;">
                    <div>
                        <strong>{{.Title}}</strong><br>
                        <small>Ejer:</small>
                        <span class="spoiler" tabindex="0">{{.OwnerName}}</span>
                    </div>
                </div>
            </header>
            <a href="https://music.youtube.com/watch?v={{.YouTubeID}}" target="_blank" role="button"
                class="secondary">Afspil p친 YouTube Music</a>
        </article>
        {{else}}
        <p>Ingen sange er tilf칮jet endnu.</p>
        {{end}}
    </div>

    <div style="margin-top: 2rem;">
        <a href="/parties/{{.Party.ID}}?admin_token={{.AdminToken}}&user={{.UserName}}" role="button">Tilbage til
            festen</a>
    </div>
</section>
{{end}}